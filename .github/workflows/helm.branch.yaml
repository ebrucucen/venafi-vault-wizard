name: "Venafi Vault Wizard Helm Example"
on:
  push:
  pull_request:
jobs:
  example:
    name: "Build and Run Example"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: examples/helm
    steps:
      - name: "Check out source code"
        uses: actions/checkout@v3
      - name: "Set up Go 1.18"
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: "install k8s"
        uses: helm/kind-action@v1.2.0
      - name: "setup helm"
        uses: azure/setup-helm@v1
        with: 
          version: v3.8.2 
        run: helm version
      - name: "Build"
        env:
          GOPROXY: "https://proxy.golang.org"
        run: make build
      - name: "Helm Dependency Update"
        run: helm dependency update
      - name: "Check cluster info"
        run: kubectl cluster-info
      - name: "Helm Install Cluster"
        run: helm install vvwtestcluster .
      - name: "Get pods"
        run: kubectl get pods
      - name: "Run pod"
        run: kubectl exec vvwtestcluster-vault-0 -- vault operator init -key-shares=1 -key-threshold=1 -format=json > init-keys.json
